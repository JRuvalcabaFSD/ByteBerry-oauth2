name: ðŸš€ Release CI - OAUTH2

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: "22.21.1"
  REGISTRY: docker.io
  IMAGE_NAME: jruvalcabafsd/byteberry-oauth2

jobs:
  setup-and-validate:
    name: âœ… Setup & Validate
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      next-version: ${{ steps.plan.outputs.next-version }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ’¾ Cache node_modules
        uses: actions/cache/save@v3
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      # TODO F1
      # - name: Generate JWT test keys
      #   run: pnpm generate:keys

      # TODO F2
      # - name: Generate Prisma Client
      #   env:
      #     DATABASE_URL: ignore
      #   run: pnpm prisma generate

      # - name: Set up Docker Compose
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y docker-compose

      - name: ðŸ“ Run full validation
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5433/oauth2_test?schema=public
        run: |
          export NODE_ENV=test
          export CI=true
          pnpm type-check
          pnpm lint
          pnpm audit
          pnpm build
          # Modificar si se agregan tests que requieran DB
          pnpm test:unit

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-release
          path: dist/
          retention-days: 1

      - name: ðŸ” Check if should release
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual release triggered"
          else
            COMMITS=$(git log --format="%s" HEAD~1..HEAD)
            if echo "$COMMITS" | grep -E "^(feat|fix|BREAKING CHANGE)"; then
              echo "should-release=true" >> $GITHUB_OUTPUT
              echo "âœ… Found releasable commits"
            else
              echo "should-release=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ No releasable commits found"
            fi
          fi

      - name: ðŸ§® Plan next version (semantic-release dry-run)
        id: plan
        if: steps.check.outputs.should-release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Running semantic-release in dry-run mode..."
          pnpm dlx semantic-release --dry-run --no-ci > sr-dry-run.log 2>&1 || true

          # Extraer la versiÃ³n planeada
          NEXT=$(grep -Eo "next release version is [0-9]+\.[0-9]+\.[0-9]+" sr-dry-run.log | awk '{print $NF}' | tail -n1)

          if [ -z "$NEXT" ]; then
            echo "âš ï¸ No new version planned by semantic-release"
            echo "next-version=" >> $GITHUB_OUTPUT
          else
            echo "next-version=$NEXT" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Planned next version: $NEXT"
          fi

  docker:
    name: ðŸ³ Build & Push Docker
    runs-on: ubuntu-latest
    needs: [setup-and-validate]
    if: needs.setup-and-validate.outputs.next-version != ''
    outputs:
      image-pushed: ${{ steps.pushcheck.outputs.ok }}
      version: ${{ steps.vars.outputs.version }}
      image-tag: ${{ steps.vars.outputs.image-tag }}
      image-latest: ${{ steps.vars.outputs.image-latest }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Compute version & tags
        id: vars
        run: |
          VERSION="${{ needs.setup-and-validate.outputs.next-version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "image-tag=${{ env.IMAGE_NAME }}:$VERSION" >> $GITHUB_OUTPUT
          echo "image-latest=${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Will build version: $VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}},value=${{ steps.vars.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.vars.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.vars.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.description=ByteBerry OAuth2 API
            org.opencontainers.image.vendor=JRuvalcabaFSD
            org.opencontainers.image.version=${{ steps.vars.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: ðŸ—ƒï¸ Build & push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            VERSION=${{ steps.vars.outputs.version }}
          tags: |
            ${{ steps.vars.outputs.image-tag }}
            ${{ steps.vars.outputs.image-latest }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: ðŸ§ª Test multi-arch images
        run: |
          echo "ðŸ§ª Testing published images..."

          echo "Testing AMD64 image..."
          docker run --rm --platform linux/amd64 -e NODE_ENV=test \
            ${{ steps.vars.outputs.image-tag }} \
            node -e "console.log('âœ… AMD64 image working - version ${{ steps.vars.outputs.version }}')"

          echo "Testing ARM64 image availability..."
          docker manifest inspect ${{ steps.vars.outputs.image-tag }} | grep "arm64" && echo "âœ… ARM64 image available"

      - name: âœ… Verify push (manifest)
        id: pushcheck
        run: |
          docker buildx imagetools inspect "${{ steps.vars.outputs.image-tag }}"
          docker buildx imagetools inspect "${{ steps.vars.outputs.image-latest }}"
          echo "ok=true" >> $GITHUB_OUTPUT
          echo "âœ… Multi-arch images verified"

      - name: ðŸ“Š Image summary
        run: |
          echo "## ðŸ³ Docker Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Platforms | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ steps.vars.outputs.version }}\` | linux/amd64, linux/arm64 | âœ… Published |" >> $GITHUB_STEP_SUMMARY
          echo "| \`latest\` | linux/amd64, linux/arm64 | âœ… Published |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Pull Commands:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Specific version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.vars.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Latest version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.vars.outputs.image-latest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Raspberry Pi 5 (ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "docker pull --platform linux/arm64 ${{ steps.vars.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  release:
    name: ðŸ·ï¸ Publish Release
    runs-on: ubuntu-latest
    needs: [setup-and-validate, docker]
    if: |
      needs.setup-and-validate.outputs.should-release == 'true' &&
      needs.docker.result == 'success' &&
      needs.docker.outputs.image-pushed == 'true'
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag: ${{ steps.get-version.outputs.tag }}
    steps:
      - name: Create GitHub App installation token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: ðŸ“¥ Checkout code with App token
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ“¦ Run semantic-release (REAL)
        id: sr
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }} # token from GitHub App installation
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "ðŸš€ Running semantic-release to publish..."
          pnpm dlx semantic-release --no-ci

      - name: ðŸ“‹ Get published version
        id: get-version
        run: |
          git fetch --tags
          TAG=$(git describe --tags --abbrev=0)
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "âœ… Published version: $VERSION"
          echo "âœ… Created tag: $TAG"

      - name: ðŸ“Š Release summary
        run: |
          echo "## ðŸŽ‰ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Version | \`${{ steps.get-version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Tag | \`${{ steps.get-version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker | \`${{ needs.docker.outputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  sync-develop:
    name: ðŸ”„ Sync develop with release
    runs-on: ubuntu-latest
    needs: [release, docker]
    if: needs.release.result == 'success'
    steps:
      - name: Create GitHub App installation token
        id: app-token-sync
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: ðŸ“¥ Checkout code with App token
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token-sync.outputs.token }}

      - name: ðŸ” Check if sync needed
        id: check
        run: |
          git fetch origin develop main --tags

          # Verificar si develop existe
          if ! git rev-parse --verify origin/develop &>/dev/null; then
            echo "sync-needed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Branch develop does not exist, skipping sync"
            exit 0
          fi

          # Verificar commits ahead en main
          COMMITS_AHEAD=$(git rev-list --count origin/develop..origin/main)

          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "sync-needed=false" >> $GITHUB_OUTPUT
            echo "âœ… Develop is already up to date"
          else
            echo "sync-needed=true" >> $GITHUB_OUTPUT
            echo "commits-ahead=$COMMITS_AHEAD" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Develop is $COMMITS_AHEAD commits behind main"
          fi

      - name: ðŸ”„ Sync develop with main
        if: steps.check.outputs.sync-needed == 'true'
        run: |
          RELEASE_VERSION="${{ needs.release.outputs.version }}"
          RELEASE_TAG="${{ needs.release.outputs.tag }}"

          echo "ðŸ”„ Syncing develop with main after release $RELEASE_TAG..."

          # Configurar git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Checkout develop
          git checkout develop
          git pull origin develop

          # Intentar fast-forward merge primero
          if git merge-base --is-ancestor origin/develop origin/main; then
            echo "âœ… Fast-forward merge possible"
            git merge --ff-only origin/main
          else
            echo "âš ï¸ Fast-forward not possible, creating merge commit"
            git merge --no-ff origin/main -m "chore: sync develop with release ${RELEASE_TAG}

            Auto-sync after successful Release-CI completion.

            Release info:
            * Version: ${RELEASE_VERSION}
            * Tag: ${RELEASE_TAG}
            * Docker: ${{ needs.docker.outputs.image-tag }}
            * Trigger: ${{ github.event_name }}
            * Commit: ${{ github.sha }}"
          fi

          # Push develop (credentials come from checkout token)
          git push origin develop
          echo "âœ… Develop synced with release $RELEASE_TAG"

      - name: ðŸ“Š Sync summary
        run: |
          if [ "${{ steps.check.outputs.sync-needed }}" == "true" ]; then
            echo "## ðŸ”„ Develop Sync Completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“¦ Release Version | \`${{ needs.release.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ·ï¸ Release Tag | \`${{ needs.release.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“ Commits Synced | ${{ steps.check.outputs.commits-ahead }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŽ¯ Target Branch | develop |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Status | Synchronized |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check.outputs.sync-needed }}" == "false" ]; then
            echo "## âœ… No Sync Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Develop branch is already up to date with main." >> $GITHUB_STEP_SUMMARY
          fi
