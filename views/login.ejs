<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ByteBerry - Login</title>
	<link rel="icon" type="image/svg+xml" href="/favicon.svg">
	<link rel="stylesheet" href="/css/output.css">
</head>

<body class="bg-dark-300 min-h-screen flex items-center justify-center p-6">
	<div class="w-full max-w-md">
		<!-- Header -->
		<div class="text-center mb-8">
			<div class="flex items-center justify-center mb-4">
				<span class="text-6xl">ü´ê</span>
			</div>
			<h1 class="text-4xl font-bold text-white mb-2">ByteBerry</h1>
			<p class="text-gray-400">Sistema de Gesti√≥n de Gastos</p>
		</div>

		<!-- Login Card -->
		<div class="bg-dark-100 rounded-lg border border-gray-700 shadow-xl p-8">
			<!-- Messages -->
			<div id="errorMessage"
				class="hidden bg-red-900/30 border border-red-700 text-red-400 px-4 py-3 rounded-lg mb-4 text-sm">
				<div class="flex items-center">
					<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd"
							d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
							clip-rule="evenodd" />
					</svg>
					<span id="errorText"></span>
				</div>
			</div>

			<div id="successMessage"
				class="hidden bg-green-900/30 border border-green-700 text-green-400 px-4 py-3 rounded-lg mb-4 text-sm">
				<div class="flex items-center">
					<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd"
							d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
							clip-rule="evenodd" />
					</svg>
					<span id="successText"></span>
				</div>
			</div>

			<!-- Form -->
			<form id="loginForm" class="space-y-6">
				<!-- ‚ú® NUEVO: Campo hidden para return_url -->
				<input type="hidden" name="return_url" value="<%= returnUrl || '' %>">

				<!-- Email/Username Input -->
				<div>
					<label for="emailOrUserName" class="block text-sm font-medium text-gray-300 mb-2">
						Email o Usuario
					</label>
					<input type="text" id="emailOrUserName" name="emailOrUserName" placeholder="admin@byteberry.dev" required
						autocomplete="username"
						class="w-full px-4 py-3 bg-dark-200 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
				</div>

				<!-- Password Input -->
				<div>
					<label for="password" class="block text-sm font-medium text-gray-300 mb-2">
						Contrase√±a
					</label>
					<input type="password" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
						autocomplete="current-password"
						class="w-full px-4 py-3 bg-dark-200 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
				</div>

				<!-- Remember Me -->
				<div class="flex items-center">
					<input type="checkbox" id="rememberMe" name="rememberMe"
						class="w-4 h-4 bg-dark-200 border-gray-600 rounded text-primary focus:ring-primary focus:ring-offset-dark-100">
					<label for="rememberMe" class="ml-2 text-sm text-gray-400 cursor-pointer">
						Mantenerme conectado (30 d√≠as)
					</label>
				</div>

				<!-- Submit Button -->
				<button type="submit" id="btnLogin"
					class="w-full px-4 py-3 bg-primary hover:bg-primary-dark text-white font-semibold rounded-lg transition duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-dark-100 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
					<span id="btnText">Iniciar Sesi√≥n</span>
				</button>
			</form>
		</div>

		<!-- Demo Credentials -->
		<div class="mt-8 bg-dark-100 rounded-lg border border-gray-700 p-6">
			<div class="flex items-center mb-4">
				<svg class="w-5 h-5 text-primary mr-2" fill="currentColor" viewBox="0 0 20 20">
					<path fill-rule="evenodd"
						d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
						clip-rule="evenodd" />
				</svg>
				<h3 class="text-sm font-semibold text-gray-300">Usuarios de Prueba (F1 Development)</h3>
			</div>
			<div class="space-y-2 text-sm">
				<div
					class="flex items-center justify-between bg-dark-200 px-3 py-2 rounded cursor-pointer hover:ring-2 hover:ring-primary transition-all demo-credential"
					data-email="admin@byteberry.dev" data-password="admin123">
					<code class="text-gray-400">admin@byteberry.dev</code>
					<code class="text-primary">admin123</code>
				</div>
				<div
					class="flex items-center justify-between bg-dark-200 px-3 py-2 rounded cursor-pointer hover:ring-2 hover:ring-primary transition-all demo-credential"
					data-email="user@byteberry.dev" data-password="user123">
					<code class="text-gray-400">user@byteberry.dev</code>
					<code class="text-primary">user123</code>
				</div>
				<div
					class="flex items-center justify-between bg-dark-200 px-3 py-2 rounded cursor-pointer hover:ring-2 hover:ring-primary transition-all demo-credential"
					data-email="demo@byteberry.dev" data-password="demo123">
					<code class="text-gray-400">demo@byteberry.dev</code>
					<code class="text-primary">demo123</code>
				</div>
			</div>
		</div>

		<!-- Footer -->
		<div class="mt-6 text-center">
			<p class="text-sm text-gray-500">
				ByteBerry v<%= version %> - F1 Arabasta Saga
			</p>
		</div>
	</div>

	<script nonce="<%= nonce %>">
		const form = document.getElementById('loginForm');
		const btnLogin = document.getElementById('btnLogin');
		const btnText = document.getElementById('btnText');
		const errorMessage = document.getElementById('errorMessage');
		const errorText = document.getElementById('errorText');
		const successMessage = document.getElementById('successMessage');
		const successText = document.getElementById('successText');

		function hideMessages() {
			errorMessage.classList.add('hidden');
			successMessage.classList.add('hidden');
		}

		const showError = (message, errors = []) => {
			const errorDiv = document.getElementById('errorMessage');
			const errorText = document.getElementById('errorText');

			// Si hay una lista de errores, creamos una lista HTML
			if (errors && errors.length > 0) {
				const listHtml = `
					<p class="font-bold mb-1">${message}</p>
					<ul class="list-disc list-inside ml-2">
						${errors.map(err => `<li>${err}</li>`).join('')}
					</ul>
				`;
				errorText.innerHTML = listHtml;
			} else {
				// Si no hay array, mostramos solo el mensaje de texto
				errorText.textContent = message;
			}

			errorDiv.classList.remove('hidden');
			setTimeout(() => {
				errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
			}, 100);
		};

		function showSuccess(message) {
			hideMessages();
			successText.textContent = message;
			successMessage.classList.remove('hidden');
		}

		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			hideMessages();

			btnLogin.disabled = true;
			btnText.innerHTML = `
				<svg class="animate-spin inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
					viewBox="0 0 24 24">
					<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
					<path class="opacity-75" fill="currentColor"
						d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
					</path>
				</svg>
				Iniciando sesi√≥n...
			`;

			const formData = new FormData(form);
			const emailOrUserName = formData.get('emailOrUserName');
			const password = formData.get('password');
			const rememberMe = formData.get('rememberMe') === 'on';
			const returnUrl = formData.get('return_url'); // ‚ú® NUEVO: Extraer return_url

			try {
				const response = await fetch('/auth/login', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						emailOrUserName: emailOrUserName,
						password: password,
						rememberMe: rememberMe,
						return_url: returnUrl || undefined, // ‚ú® NUEVO: Enviar return_url
					}),
				});

				// ‚ú® NUEVO: Manejar redirect del servidor
				if (response.redirected) {
					window.location.href = response.url;
					return;
				}

				const data = await response.json();

				if (response.ok) {
					showSuccess(data.message || 'Login exitoso');

					// ‚ú® MODIFICADO: Usar return_url si existe, sino ir a dashboard
					setTimeout(() => {
						const redirectUrl = returnUrl || '/dashboard';
						window.location.href = redirectUrl;
					}, 1000);
				} else {
					const mainMessage = data.message || 'Error al iniciar sesi√≥n';
					const detailErrors = data.errors || [];

					showError(mainMessage, detailErrors);
					btnLogin.disabled = false;
					btnText.textContent = 'Iniciar Sesi√≥n';
				}
			} catch (error) {
				showError('Error de conexi√≥n. Por favor intenta de nuevo.');
				btnLogin.disabled = false;
				btnText.textContent = 'Iniciar Sesi√≥n';
			}
		});

		// Auto-fill demo credentials
		document.querySelectorAll('.demo-credential').forEach((element) => {
			element.addEventListener('click', () => {
				const email = element.dataset.email;
				const password = element.dataset.password;

				document.getElementById('emailOrUserName').value = email;
				document.getElementById('password').value = password;
			});
		});
	</script>
</body>

</html>
